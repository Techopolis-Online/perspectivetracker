{% extends 'users/base.html' %}
{% load project_tags %}

{% block title %}
    Issue: {{ issue.issue_description|truncatechars:50 }}
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Hidden CSRF token for AJAX requests -->
    {% csrf_token %}
    
    <div class="row">
        <div class="col-md-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'projects:project_list' %}">Projects</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'projects:project_detail' issue.project.id %}">{{ issue.project.name }}</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Issue Details</li>
                </ol>
            </nav>
            
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h2 class="h5 mb-0">Issue Details</h2>
                    <div>
                        <a href="{% url 'projects:issue_edit' issue.project.id issue.id %}" class="btn btn-sm btn-outline-primary me-2">
                            <i class="bi bi-pencil"></i> Edit
                        </a>
                        {% if user.is_superuser or user.role.name == 'admin' %}
                        <a href="{% url 'projects:issue_delete' issue.project.id issue.id %}" class="btn btn-sm btn-outline-danger">
                            <i class="bi bi-trash"></i> Delete
                        </a>
                        {% endif %}
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h3 class="h6 border-bottom pb-2">Basic Information</h3>
                            <div class="mb-3">
                                <strong>Page/Scenario:</strong> {{ issue.page.name }}
                            </div>
                            <div class="mb-3">
                                <strong>Milestone:</strong> {{ issue.milestone.name }}
                            </div>
                            {% if issue.violation %}
                            <div class="mb-3">
                                <strong>Violation:</strong> {{ issue.violation.name }}
                            </div>
                            {% endif %}
                            <div class="mb-3">
                                <strong>Status:</strong> 
                                <span class="badge {% if issue.current_status == 'ready_for_testing' %}bg-info{% elif issue.current_status == 'in_progress' %}bg-warning{% elif issue.current_status == 'resolved' %}bg-success{% elif issue.current_status == 'closed' %}bg-secondary{% else %}bg-danger{% endif %} status-badge">
                                    {{ issue.get_current_status_display }}
                                </span>
                                {% if issue.current_status != 'ready_for_testing' and user|can_mark_ready_for_testing %}
                                <div class="form-check form-switch d-inline-block ms-2">
                                    <input class="form-check-input ready-for-testing-checkbox" type="checkbox" 
                                           id="readyForTesting" data-issue-id="{{ issue.id }}"
                                           data-project-id="{{ issue.project.id }}"
                                           {% if issue.current_status == 'ready_for_testing' %}checked{% endif %}>
                                    <label class="form-check-label" for="readyForTesting">
                                        Mark as Ready for Testing
                                    </label>
                                </div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <strong>User Impact:</strong> 
                                <span class="badge {% if issue.user_impact == 'high' %}bg-danger{% elif issue.user_impact == 'low' %}bg-warning text-dark{% else %}bg-info{% endif %}">
                                    {{ issue.get_user_impact_display }}
                                </span>
                            </div>
                            <div class="mb-3">
                                <strong>Tool/Method:</strong> {{ issue.get_tool_or_method_display }}
                            </div>
                            <div class="mb-3">
                                <strong>Created:</strong> {{ issue.created_at|date:"M d, Y" }}
                            </div>
                            <div class="mb-3">
                                <strong>Last Updated:</strong> {{ issue.updated_at|date:"M d, Y" }}
                            </div>
                            {% if issue.assigned_to %}
                            <div class="mb-3">
                                <strong>Assigned To:</strong> {{ issue.assigned_to.get_full_name }}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h3 class="h6 border-bottom pb-2">Issue Details</h3>
                            <div class="mb-3">
                                <strong>Issue Description:</strong>
                                <p class="mt-2">{{ issue.issue_description|linebreaks }}</p>
                            </div>
                            <div class="mb-3">
                                <strong>Steps to Reproduce:</strong>
                                <p class="mt-2">{{ issue.steps_to_reproduce|linebreaks }}</p>
                            </div>
                            <div class="mb-3">
                                <strong>User Impact Description:</strong>
                                <p class="mt-2">{{ issue.user_impact_description|linebreaks }}</p>
                            </div>
                            {% if issue.workarounds %}
                            <div class="mb-3">
                                <strong>Workarounds:</strong>
                                <p class="mt-2">{{ issue.workarounds|linebreaks }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    
                    {% if issue.dynamic_fields %}
                    <div class="row">
                        <div class="col-md-12">
                            <h3 class="h6 border-bottom pb-2">Additional Information</h3>
                            <div class="row">
                                {% for field in issue.project.project_type.issue_fields %}
                                    {% with field_value=issue.dynamic_fields|get_item:field.name %}
                                        {% if field_value %}
                                        <div class="col-md-6 mb-3">
                                            <strong>{{ field.label|default:field.name|title }}:</strong>
                                            {% if field.type == 'checkbox' %}
                                                {% if field_value %}
                                                    <i class="bi bi-check-circle-fill text-success"></i> Yes
                                                {% else %}
                                                    <i class="bi bi-x-circle text-muted"></i> No
                                                {% endif %}
                                            {% else %}
                                                <p class="mt-2">{{ field_value }}</p>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if issue.attachment %}
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h3 class="h6 border-bottom pb-2">Attachments</h3>
                            <div class="mb-3">
                                <a href="{{ issue.attachment.url }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                    <i class="bi bi-file-earmark"></i> {{ issue.attachment.name|split:"/"|last }}
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="mt-4">
                        <a href="{% url 'projects:project_detail' issue.project.id %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Back to Project
                        </a>
                        
                        {% if issue.current_status != 'ready_for_testing' and user|can_mark_ready_for_testing %}
                        <form id="readyForTestingForm" class="d-inline-block ms-2">
                            {% csrf_token %}
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="markReadyForTesting">
                                <label class="form-check-label" for="markReadyForTesting">
                                    Mark as Ready for Testing
                                </label>
                            </div>
                        </form>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Comments Section -->
            <div id="comments" class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center bg-primary text-white">
                    <h2 class="h5 mb-0"><i class="bi bi-chat-dots me-2"></i>Comments ({{ comments.count }})</h2>
                </div>
                <div class="card-body p-0">
                    <div class="container-fluid">
                        <div class="row">
                            <!-- Comments List -->
                            <div class="col-md-8 py-3">
                                <div class="comments-list p-3 bg-white rounded" id="commentsList" style="max-height: 65vh; overflow-y: auto;">
                                    {% include 'projects/includes/comments_list.html' with comments=comments can_see_internal=can_see_internal issue=issue %}
                                </div>
                            </div>
                            
                            <!-- Comment Form -->
                            <div class="col-md-4 bg-light py-3">
                                <div class="sticky-top pt-2">
                                    <div class="card shadow-sm">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="card-title mb-0"><i class="bi bi-plus-circle me-2"></i>Add Comment</h5>
                                        </div>
                                        <div class="card-body">
                                            <form method="post" class="mb-4" id="issueCommentForm">
                                                {% csrf_token %}
                                                
                                                <!-- Status Update Section -->
                                                <div class="mb-3">
                                                    <label for="new_status" class="form-label fw-bold">Change Status:</label>
                                                    <select class="form-select" id="new_status" name="new_status">
                                                        <option value="">No change</option>
                                                        <option value="pass" {% if issue.current_status == 'pass' %}selected{% endif %}>Pass</option>
                                                        <option value="fail" {% if issue.current_status == 'fail' %}selected{% endif %}>Fail</option>
                                                        <option value="qa" {% if issue.current_status == 'qa' %}selected{% endif %}>QA</option>
                                                        <option value="in_remediation" {% if issue.current_status == 'in_remediation' %}selected{% endif %}>In Remediation</option>
                                                        <option value="ready_for_testing" {% if issue.current_status == 'ready_for_testing' %}selected{% endif %}>Ready For Testing</option>
                                                    </select>
                                                    <div class="form-text">
                                                        <i class="bi bi-info-circle me-1"></i> Current status: <strong>{{ issue.get_current_status_display }}</strong>
                                                    </div>
                                                </div>
                                                
                                                <div class="mb-3">
                                                    <label for="{{ comment_form.text.id_for_label }}" class="form-label fw-bold">Comment:</label>
                                                    {{ comment_form.text }}
                                                    {% if comment_form.text.errors %}
                                                        <div class="invalid-feedback d-block">{{ comment_form.text.errors }}</div>
                                                    {% endif %}
                                                </div>
                                                
                                                {% if can_see_internal %}
                                                <div class="mb-3">
                                                    <label for="{{ comment_form.comment_type.id_for_label }}" class="form-label fw-bold">Comment Type:</label>
                                                    {{ comment_form.comment_type }}
                                                    {% if comment_form.comment_type.errors %}
                                                        <div class="invalid-feedback d-block">{{ comment_form.comment_type.errors }}</div>
                                                    {% endif %}
                                                    <div class="form-text small">Internal comments are only visible to staff and administrators.</div>
                                                </div>
                                                {% else %}
                                                    {{ comment_form.comment_type }}
                                                {% endif %}
                                                
                                                <input type="hidden" name="change_status" value="true">
                                                
                                                <div class="d-grid">
                                                    <button type="button" id="submitComment" class="btn btn-primary">
                                                        <i class="bi bi-send me-1"></i>Save Comment & Update Status
                                                    </button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.avatar-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.comment {
    transition: all 0.2s ease;
}

.comment:hover {
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
</style>
{% endblock %}

{% block extra_js %}
<script>
    // Helper function to show alerts
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.setAttribute('role', 'alert');
        alertDiv.innerHTML = `
            <strong>${type === 'success' ? 'Success!' : 'Error!'}</strong> ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.container').prepend(alertDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alertDiv);
            bsAlert.close();
        }, 5000);
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Handle comment form submission
        const commentForm = document.getElementById('issueCommentForm');
        const submitButton = document.getElementById('submitComment');
        
        if (commentForm && submitButton) {
            submitButton.addEventListener('click', function() {
                const formData = new FormData(commentForm);
                
                // Add a loading state to the button
                const originalHtml = this.innerHTML;
                this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...';
                this.disabled = true;
                
                // Check if status change is requested
                const statusSelect = commentForm.querySelector('[name="new_status"]');
                const newStatus = statusSelect ? statusSelect.value : null;
                
                if (newStatus) {
                    formData.set('change_status', 'true');
                }
                
                fetch(window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.status === 403) {
                        throw new Error('Permission denied: You do not have permission to add comments.');
                    }
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // Show success message
                        showAlert('success', data.message || 'Comment added successfully!');
                        
                        // Reset the form
                        commentForm.reset();
                        
                        // Update the comments list
                        if (data.html) {
                            document.getElementById('commentsList').innerHTML = data.html;
                        }
                        
                        // Update status badge if status was changed
                        if (newStatus && data.new_status_display) {
                            const statusBadge = document.querySelector('.status-badge');
                            if (statusBadge) {
                                statusBadge.textContent = data.new_status_display;
                                
                                // Update badge class based on status
                                statusBadge.className = 'badge status-badge ';
                                if (newStatus === 'ready_for_testing') statusBadge.className += 'bg-info';
                                else if (newStatus === 'in_progress' || newStatus === 'in_remediation') statusBadge.className += 'bg-warning';
                                else if (newStatus === 'resolved' || newStatus === 'pass') statusBadge.className += 'bg-success';
                                else if (newStatus === 'closed') statusBadge.className += 'bg-secondary';
                                else statusBadge.className += 'bg-danger';
                            }
                            
                            // Scroll to top of comments to see the new comment
                            document.getElementById('commentsList').scrollTop = 0;
                        }
                    } else {
                        showAlert('danger', data.message || 'An error occurred');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', error.message);
                })
                .finally(() => {
                    // Reset button state
                    this.innerHTML = originalHtml;
                    this.disabled = false;
                });
            });
        }

        // Add event listener to Ready for Testing checkbox
        const checkbox = document.querySelector('.ready-for-testing-checkbox');
        if (checkbox) {
            checkbox.addEventListener('change', function(e) {
                // Get the issue ID and project ID from data attributes
                const issueId = this.dataset.issueId;
                const projectId = this.dataset.projectId;
                
                // Create form data
                const formData = new FormData();
                formData.append('ready_for_testing', this.checked);
                
                // Send AJAX request
                fetch(`/projects/${projectId}/issues/${issueId}/mark_ready_for_testing/`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (response.status === 403) {
                        throw new Error('Permission denied: You do not have permission to perform this action.');
                    }
                    return response.json();
                })
                .then(data => {
                    // Update the UI based on the response
                    if (data.success) {
                        // Update the status badge
                        const statusBadge = document.querySelector('.status-badge');
                        if (statusBadge) {
                            statusBadge.textContent = 'Ready for Testing';
                            statusBadge.className = 'badge bg-info status-badge';
                        }
                        
                        // Show success message
                        showAlert('success', data.message);
                        
                        // Hide the checkbox
                        this.closest('.form-check').style.display = 'none';
                    } else {
                        // Show error message
                        showAlert('danger', data.message || 'An error occurred');
                        // Reset checkbox state
                        this.checked = false;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', error.message);
                    // Reset checkbox state
                    this.checked = false;
                });
            });
        }
    });
</script>
{% endblock %} 