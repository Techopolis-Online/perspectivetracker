Build Failed
-----> Building on the Heroku-24 stack
-----> Using buildpack: heroku/python
-----> Python app detected
-----> Using Python 3.12.9 specified in runtime.txt
 !     Warning: The runtime.txt file is deprecated.
 !     
 !     The runtime.txt file is deprecated since it has been replaced
 !     by the more widely supported .python-version file:
 !     https://devcenter.heroku.com/changelog-items/3141
 !     
 !     Please delete your runtime.txt file and create a new file named:
 !     .python-version
 !     
 !     Make sure to include the '.' at the start of the filename.
 !     
 !     In the new file, specify your app's Python version without
 !     quotes or a 'python-' prefix. For example:
 !     3.12
 !     
 !     We strongly recommend that you use the major version form
 !     instead of pinning to an exact version, since it will allow
 !     your app to receive Python security updates.
 !     
 !     In the future support for runtime.txt will be removed and
 !     this warning will be made an error.
-----> Restoring cache
-----> Using cached install of Python 3.12.9
-----> Installing pip 24.3.1, setuptools 70.3.0 and wheel 0.45.1
-----> Installing SQLite3
-----> Installing dependencies using 'pip install -r requirements.txt'
       Requirement already satisfied: asgiref==3.8.1 (from -r requirements.txt (line 1)) (3.8.1)
       Requirement already satisfied: blinker==1.9.0 (from -r requirements.txt (line 2)) (1.9.0)
       Requirement already satisfied: certifi==2025.1.31 (from -r requirements.txt (line 3)) (2025.1.31)
       Requirement already satisfied: cffi==1.17.1 (from -r requirements.txt (line 4)) (1.17.1)
       Requirement already satisfied: charset-normalizer==3.4.1 (from -r requirements.txt (line 5)) (3.4.1)
       Requirement already satisfied: click==8.1.8 (from -r requirements.txt (line 6)) (8.1.8)
       Requirement already satisfied: colorama==0.4.6 (from -r requirements.txt (line 7)) (0.4.6)
       Requirement already satisfied: cryptography==44.0.2 (from -r requirements.txt (line 8)) (44.0.2)
       Requirement already satisfied: defusedxml==0.7.1 (from -r requirements.txt (line 9)) (0.7.1)
       Requirement already satisfied: Django==5.1.7 (from -r requirements.txt (line 10)) (5.1.7)
       Requirement already satisfied: django-editorjs-fields==0.2.7 (from -r requirements.txt (line 11)) (0.2.7)
       Requirement already satisfied: ecdsa==0.19.1 (from -r requirements.txt (line 12)) (0.19.1)
       Requirement already satisfied: Flask==3.0.2 (from -r requirements.txt (line 13)) (3.0.2)
       Requirement already satisfied: gunicorn==21.2.0 (from -r requirements.txt (line 14)) (21.2.0)
       Requirement already satisfied: idna==3.10 (from -r requirements.txt (line 15)) (3.10)
       Requirement already satisfied: itsdangerous==2.2.0 (from -r requirements.txt (line 16)) (2.2.0)
       Requirement already satisfied: Jinja2==3.1.6 (from -r requirements.txt (line 17)) (3.1.6)
       Requirement already satisfied: MarkupSafe==3.0.2 (from -r requirements.txt (line 18)) (3.0.2)
       Requirement already satisfied: oauthlib==3.2.2 (from -r requirements.txt (line 19)) (3.2.2)
       Requirement already satisfied: pillow==11.1.0 (from -r requirements.txt (line 20)) (11.1.0)
       Requirement already satisfied: pyasn1==0.4.8 (from -r requirements.txt (line 21)) (0.4.8)
       Requirement already satisfied: pycparser==2.22 (from -r requirements.txt (line 22)) (2.22)
       Requirement already satisfied: PyJWT==2.10.1 (from -r requirements.txt (line 23)) (2.10.1)
       Requirement already satisfied: python-dotenv==1.0.1 (from -r requirements.txt (line 24)) (1.0.1)
       Requirement already satisfied: python-jose==3.4.0 (from -r requirements.txt (line 25)) (3.4.0)
       Requirement already satisfied: python3-openid==3.2.0 (from -r requirements.txt (line 26)) (3.2.0)
       Requirement already satisfied: requests==2.32.3 (from -r requirements.txt (line 27)) (2.32.3)
       Requirement already satisfied: requests-oauthlib==2.0.0 (from -r requirements.txt (line 28)) (2.0.0)
       Requirement already satisfied: rsa==4.9 (from -r requirements.txt (line 29)) (4.9)
       Requirement already satisfied: six==1.17.0 (from -r requirements.txt (line 30)) (1.17.0)
       Requirement already satisfied: social-auth-app-django==5.4.3 (from -r requirements.txt (line 31)) (5.4.3)
       Requirement already satisfied: social-auth-core==4.5.6 (from -r requirements.txt (line 32)) (4.5.6)
       Requirement already satisfied: sqlparse==0.5.3 (from -r requirements.txt (line 33)) (0.5.3)
       Requirement already satisfied: tzdata==2025.1 (from -r requirements.txt (line 34)) (2025.1)
       Requirement already satisfied: urllib3==2.3.0 (from -r requirements.txt (line 35)) (2.3.0)
       Requirement already satisfied: Werkzeug==3.1.3 (from -r requirements.txt (line 36)) (3.1.3)
       Requirement already satisfied: dj-database-url==2.1.0 (from -r requirements.txt (line 37)) (2.1.0)
       Requirement already satisfied: psycopg2-binary==2.9.9 (from -r requirements.txt (line 38)) (2.9.9)
       Requirement already satisfied: whitenoise==6.6.0 (from -r requirements.txt (line 39)) (6.6.0)
       Requirement already satisfied: django-cors-headers==4.3.1 (from -r requirements.txt (line 40)) (4.3.1)
       Requirement already satisfied: django-environ==0.11.2 (from -r requirements.txt (line 41)) (0.11.2)
       Requirement already satisfied: django-redis==5.4.0 (from -r requirements.txt (line 42)) (5.4.0)
       Requirement already satisfied: redis==5.0.1 (from -r requirements.txt (line 43)) (5.0.1)
       Requirement already satisfied: packaging (from gunicorn==21.2.0->-r requirements.txt (line 14)) (24.2)
       Requirement already satisfied: typing-extensions>=3.10.0.0 (from dj-database-url==2.1.0->-r requirements.txt (line 37)) (4.13.0)
-----> $ python manage.py collectstatic --noinput
       Unknown command: 'collectstatic'
       Type 'manage.py help' for usage.
 !     Error: Unable to generate Django static files.
 !     
 !     The 'python manage.py collectstatic --noinput' Django
 !     management command to generate static files failed.
 !     
 !     See the traceback above for details.
 !     
 !     You may need to update application code to resolve this error.
 !     Or, you can disable collectstatic for this application:
 !     
 !        $ heroku config:set DISABLE_COLLECTSTATIC=1
 !     
 !     https://devcenter.heroku.com/articles/django-assets
 !     Push rejected, failed to compile Python app.
 !     Push failed
 {% extends 'users/base.html' %}

{% block title %}Clients - Perspective Tracker{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>Clients</h1>
        </div>
        <div class="col-md-4 text-end">
            {% if user.is_superuser or user.role.name == 'admin' or user.role.name == 'staff' %}
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                    <i class="bi bi-plus-lg" aria-hidden="true"></i> Add Client
                </button>
            {% endif %}
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    {% if clients %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th scope="col">Company Name</th>
                                        <th scope="col">Contact</th>
                                        <th scope="col">Email</th>
                                        <th scope="col">Point of Contact</th>
                                        <th scope="col">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for client in clients %}
                                        <tr>
                                            <td>
                                                <a href="{% url 'clients:client_detail' client.pk %}">
                                                    {{ client.company_name }}
                                                </a>
                                            </td>
                                            <td>{{ client.contact_name }}</td>
                                            <td>
                                                <a href="mailto:{{ client.email }}">{{ client.email }}</a>
                                            </td>
                                            <td>
                                                {% if client.point_of_contact %}
                                                    {{ client.point_of_contact.first_name }} {{ client.point_of_contact.last_name }}
                                                {% else %}
                                                    <span class="text-muted">Not assigned</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="btn-group" role="group" aria-label="Actions for {{ client.company_name }}">
                                                    <a href="{% url 'clients:client_detail' client.pk %}" class="btn btn-sm btn-outline-secondary">
                                                        <i class="bi bi-eye" aria-hidden="true"></i>
                                                        <span class="visually-hidden">View {{ client.company_name }}</span>
                                                    </a>
                                                    {% if user.is_superuser or user.role.name == 'admin' or user.role.name == 'staff' %}
                                                        <button type="button" class="btn btn-sm btn-outline-primary edit-client-btn" 
                                                                data-bs-toggle="modal" data-bs-target="#editClientModal" 
                                                                data-client-id="{{ client.pk }}"
                                                                data-client-company="{{ client.company_name }}"
                                                                data-client-contact="{{ client.contact_name }}"
                                                                data-client-email="{{ client.email }}"
                                                                data-client-website="{{ client.website|default:'' }}"
                                                                data-client-poc="{{ client.point_of_contact.pk|default:'' }}">
                                                            <i class="bi bi-pencil" aria-hidden="true"></i>
                                                            <span class="visually-hidden">Edit {{ client.company_name }}</span>
                                                        </button>
                                                    {% endif %}
                                                    {% if user.is_superuser or user.role.name == 'admin' %}
                                                        <button type="button" class="btn btn-sm btn-outline-danger delete-client-btn" 
                                                                data-bs-toggle="modal" data-bs-target="#deleteClientModal" 
                                                                data-client-id="{{ client.pk }}"
                                                                data-client-name="{{ client.company_name }}">
                                                            <i class="bi bi-trash" aria-hidden="true"></i>
                                                            <span class="visually-hidden">Delete {{ client.company_name }}</span>
                                                        </button>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted mb-3">No clients found.</p>
                            {% if user.is_superuser or user.role.name == 'admin' or user.role.name == 'staff' %}
                                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addClientModal">
                                    <i class="bi bi-plus-lg" aria-hidden="true"></i> Add Your First Client
                                </button>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Client Modal -->
<div class="modal fade" id="addClientModal" tabindex="-1" aria-labelledby="addClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title h5" id="addClientModalLabel">Add New Client</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'clients:client_create' %}" id="addClientForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="addClientFormErrors" class="alert alert-danger d-none" role="alert"></div>
                    <div class="mb-3">
                        <label for="id_company_name" class="form-label">Company Name</label>
                        <input type="text" name="company_name" id="id_company_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_contact_name" class="form-label">Contact Name</label>
                        <input type="text" name="contact_name" id="id_contact_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_email" class="form-label">Email</label>
                        <input type="email" name="email" id="id_email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="id_website" class="form-label">Website (optional)</label>
                        <input type="url" name="website" id="id_website" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="id_point_of_contact" class="form-label">Point of Contact</label>
                        <select name="point_of_contact" id="id_point_of_contact" class="form-select" required>
                            <option value="">---------</option>
                            {% for user in staff_users %}
                                <option value="{{ user.pk }}">{{ user.first_name }} {{ user.last_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select a staff member or administrator as the point of contact.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Client Modal -->
<div class="modal fade" id="editClientModal" tabindex="-1" aria-labelledby="editClientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title h5" id="editClientModalLabel">Edit Client</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" id="editClientForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <div id="editClientFormErrors" class="alert alert-danger d-none" role="alert"></div>
                    <div class="mb-3">
                        <label for="edit_company_name" class="form-label">Company Name</label>
                        <input type="text" name="company_name" id="edit_company_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_contact_name" class="form-label">Contact Name</label>
                        <input type="text" name="contact_name" id="edit_contact_name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">Email</label>
                        <input type="email" name="email" id="edit_email" class="form-control" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_website" class="form-label">Website (optional)</label>
                        <input type="url" name="website" id="edit_website" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="edit_point_of_contact" class="form-label">Point of Contact</label>
                        <select name="point_of_contact" id="edit_point_of_contact" class="form-select" required>
                            <option value="">---------</option>
                            {% for user in staff_users %}
                                <option value="{{ user.pk }}">{{ user.first_name }} {{ user.last_name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select a staff member or administrator as the point of contact.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Client Modal -->
<div class="modal fade" id="deleteClientModal" tabindex="-1" aria-labelledby="deleteClientModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title h5" id="deleteClientModalLabel">Delete Client</h2>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <h3 class="h6 alert-heading">Warning!</h3>
                    <p>Are you sure you want to delete <strong id="deleteClientName"></strong>? This action cannot be undone.</p>
                    <p>All associated notes and data will be permanently deleted.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="post" id="deleteClientForm">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Helper function to display form errors
        function displayFormErrors(errorContainer, errors) {
            errorContainer.innerHTML = '';
            errorContainer.classList.remove('d-none');
            
            if (typeof errors === 'object') {
                const ul = document.createElement('ul');
                ul.className = 'mb-0';
                
                for (const field in errors) {
                    const li = document.createElement('li');
                    li.textContent = `${field}: ${errors[field].join(' ')}`;
                    ul.appendChild(li);
                }
                
                errorContainer.appendChild(ul);
            } else {
                errorContainer.textContent = 'An error occurred. Please try again.';
            }
        }
        
        // Edit client modal
        const editClientModal = document.getElementById('editClientModal');
        if (editClientModal) {
            editClientModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const clientId = button.getAttribute('data-client-id');
                const companyName = button.getAttribute('data-client-company');
                const contactName = button.getAttribute('data-client-contact');
                const email = button.getAttribute('data-client-email');
                const website = button.getAttribute('data-client-website');
                const poc = button.getAttribute('data-client-poc');
                
                const form = editClientModal.querySelector('#editClientForm');
                form.action = `/clients/${clientId}/update/`;
                
                const companyNameInput = form.querySelector('#edit_company_name');
                const contactNameInput = form.querySelector('#edit_contact_name');
                const emailInput = form.querySelector('#edit_email');
                const websiteInput = form.querySelector('#edit_website');
                const pocSelect = form.querySelector('#edit_point_of_contact');
                
                companyNameInput.value = companyName;
                contactNameInput.value = contactName;
                emailInput.value = email;
                websiteInput.value = website;
                
                // Set the selected option for point of contact
                if (poc) {
                    for (let i = 0; i < pocSelect.options.length; i++) {
                        if (pocSelect.options[i].value === poc) {
                            pocSelect.options[i].selected = true;
                            break;
                        }
                    }
                } else {
                    // If no point of contact, select the first option (blank)
                    pocSelect.options[0].selected = true;
                }
                
                // Clear any previous errors
                const errorContainer = form.querySelector('#editClientFormErrors');
                errorContainer.classList.add('d-none');
                errorContainer.innerHTML = '';
            });
        }
        
        // Delete client modal
        const deleteClientModal = document.getElementById('deleteClientModal');
        if (deleteClientModal) {
            deleteClientModal.addEventListener('show.bs.modal', function(event) {
                const button = event.relatedTarget;
                const clientId = button.getAttribute('data-client-id');
                const clientName = button.getAttribute('data-client-name');
                
                const form = deleteClientModal.querySelector('#deleteClientForm');
                form.action = `/clients/${clientId}/delete/`;
                
                const clientNameElement = deleteClientModal.querySelector('#deleteClientName');
                clientNameElement.textContent = clientName;
            });
        }
        
        // Add client form submission
        const addClientForm = document.getElementById('addClientForm');
        if (addClientForm) {
            addClientForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Clear any previous errors
                const errorContainer = this.querySelector('#addClientFormErrors');
                errorContainer.classList.add('d-none');
                errorContainer.innerHTML = '';
                
                // Submit the form using fetch API to stay on the same page
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json().then(data => {
                            // Reload the page to show the new client
                            window.location.reload();
                        });
                    } else {
                        return response.json().then(data => {
                            // Display errors
                            displayFormErrors(errorContainer, data.errors);
                        })
                        .catch(error => {
                            // If the response is not valid JSON
                            console.error('Error parsing JSON:', error);
                            errorContainer.classList.remove('d-none');
                            errorContainer.textContent = 'An error occurred while processing your request. Please try again.';
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorContainer.classList.remove('d-none');
                    errorContainer.textContent = 'An unexpected error occurred. Please try again.';
                });
            });
        }
        
        // Edit client form submission
        const editClientForm = document.getElementById('editClientForm');
        if (editClientForm) {
            editClientForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Clear any previous errors
                const errorContainer = this.querySelector('#editClientFormErrors');
                errorContainer.classList.add('d-none');
                errorContainer.innerHTML = '';
                
                // Submit the form using fetch API to stay on the same page
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json().then(data => {
                            // Reload the page to show the updated client
                            window.location.reload();
                        });
                    } else {
                        return response.json().then(data => {
                            // Display errors
                            displayFormErrors(errorContainer, data.errors);
                        })
                        .catch(error => {
                            // If the response is not valid JSON
                            console.error('Error parsing JSON:', error);
                            errorContainer.classList.remove('d-none');
                            errorContainer.textContent = 'An error occurred while processing your request. Please try again.';
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorContainer.classList.remove('d-none');
                    errorContainer.textContent = 'An unexpected error occurred. Please try again.';
                });
            });
        }
        
        // Delete client form submission
        const deleteClientForm = document.getElementById('deleteClientForm');
        if (deleteClientForm) {
            deleteClientForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                // Submit the form using fetch API to stay on the same page
                fetch(this.action, {
                    method: 'POST',
                    body: new FormData(this),
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        return response.json().then(data => {
                            // Reload the page to show the client has been deleted
                            window.location.reload();
                        })
                        .catch(error => {
                            // If the response is not valid JSON but the request was successful
                            window.location.reload();
                        });
                    } else {
                        console.error('Delete operation failed');
                        alert('Failed to delete the client. Please try again.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An unexpected error occurred. Please try again.');
                });
            });
        }
    });
</script>
{% endblock %}